---
title: "Simpsons_Emery_cooking"
author: "Emery Lauer"
date: "2025-04-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
#install.packages("plotly")
```

## EDA

```{r}
df_ep <- read.csv("data/simpsons_episodes.csv")
df_script <- read.csv("data/simpsons_script_lines.csv")

head(df_ep)
head(df_script)

```

#### Compute the total number of words per episode & plot relative to viewership

```{r}
df_words_per_epsiode <-
  df_script %>% 
  filter(speaking_line == TRUE) %>% 
  mutate(word_count = as.numeric(word_count)) %>%
  filter(word_count <= 1000) %>% 
  group_by(episode_id) %>% 
  summarise(total_words_per_episode = sum(word_count)) %>% 
  inner_join(df_ep_new, by = "episode_id")

df_words_per_epsiode

df_words_per_epsiode %>%
  ggplot(aes(total_words_per_episode, us_viewers_in_millions)) +
  geom_point()
```

#### Compute words over time

```{r}
df_words_per_epsiode %>%
  ggplot(aes(episode_id, total_words_per_episode)) +
  geom_point() +
  geom_smooth()
```

#### Test Code - Filter & Sum Total Words by Character

```{r}
df_script %>%
  filter(speaking_line == TRUE) %>% 
  filter(episode_id == 1) %>% 
  mutate(word_count = as.numeric(word_count)) %>% 
  filter(word_count <= 1000) %>% 
  group_by(raw_character_text) %>% 
  summarize(total_word_count = sum(word_count)) %>% 
  slice_max(total_word_count, n = 6) %>% 
  arrange(desc(total_word_count))
```

#### Compute Speech Complexity

```{r}
unique_words <- function(line)
  # Convert all characters to lowercase
  tolower(line) %>% 
  # Remove all non-alphanumeric characters (ie punctuation)
  gsub("[^[:alnum:] ]", "", .) %>%
  # Split into individual words
  str_split(" +") %>%
  # Deal with weird list-in-a-list thing 
  .[[1]] %>% 
  # Count onlthe unique (non-repeat words)
  unique() %>% 
  # Get total number of words
  length()

df_speech_complexity <-
  df_script %>%
  mutate(word_count = as.numeric(word_count)) %>%
  # filter(episode_id == 1) %>%
  filter(
    grepl(
      "Simpson",
      raw_character_text
    )
  ) %>%
  group_by(raw_character_text) %>%
  summarise(
    all_words = paste0(normalized_text, collapse = " "),
    num_unique_words = unique_words(all_words),
    total_words = sum(word_count, na.rm = TRUE),
    speech_complexity = num_unique_words / total_words
  ) %>%
  arrange(speech_complexity) %>% 
  slice_max(total_words, n = 4, with_ties = FALSE)

df_speech_complexity

df_speech_complexity %>% 
  mutate(raw_character_text = fct_reorder(raw_character_text, speech_complexity)) %>% 
  ggplot(aes(raw_character_text, speech_complexity, fill = raw_character_text)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

#### Actual Code - Turn above into function, summing selecting top 5 characters from every episode in the datset

Additionally, this code joins the total words per episode and computes the percentage of the script relative to each character

```{r}
get_word_counts_per_episode <- function(df_script) {
  df_script %>%
    filter(speaking_line == TRUE) %>%
    mutate(
      word_count = (as.numeric(word_count))
    ) %>%
    filter(!is.na(word_count)) %>%
    filter(word_count <= 1000) %>% 
    group_by(episode_id, raw_character_text) %>%
    summarize(total_word_count = sum(word_count), .groups = "drop") %>%
    group_by(episode_id) %>%
    slice_max(total_word_count, n = 1, with_ties = FALSE) %>%
    arrange(episode_id, desc(total_word_count))
}

episode_word_counts <- 
  get_word_counts_per_episode(df_script) %>% 
  inner_join(df_words_per_epsiode, by = "episode_id") %>% 
  select(c("episode_id", "raw_character_text", "total_word_count", "total_words_per_episode")) %>% 
  mutate(percentage_of_script = total_word_count / total_words_per_episode)
episode_word_counts

```

#### Join compiled total words data with general episode data (including ratings & viewership

```{r}
 df_ep_new <- df_ep %>% 
  select(id, imdb_votes, original_air_date, original_air_year, us_viewers_in_millions, views) %>% 
  rename(
    episode_id = id
  )


df_simpsons <- df_ep_new %>%
  left_join(episode_word_counts, by = "episode_id")

df_simpsons
```

#### First plot - select only the main characters (the Simpsons and a few others of interest) and plot

```{r}
# Bart|Homer|Marge|Lisa|Maggie|
df_simpsons %>% 
  filter(grepl("Simpson|Santa's Little Helper|Obama|Trump|Millhouse|Chief Wiggum", raw_character_text)) %>% 
ggplot(
    aes(x = `episode_id`, y = us_viewers_in_millions, color = raw_character_text)
  ) +
  geom_point() 
# labs(
#   title = "Serotonin Levels vs. # of Friends",
#   x = "Number of Friends",
#   y = "Serotonin (ng/mL)",
# )
```

#### Create a similar graph in Boxplot form

```{r}
df_simpsons %>% 
  filter(grepl("Simpson|Santa's Little Helper|Obama|Trump|Millhouse|Chief Wiggum", raw_character_text)) %>% 
  #group_by(raw_character_text) %>% 
ggplot(
    aes(x = raw_character_text, y = us_viewers_in_millions, fill = raw_character_text)
  ) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

#### Compile data per year

```{r}
df_simpsons %>% 
  filter(grepl("Simpson|Santa's Little Helper|Obama|Trump|Millhouse|Chief Wiggum", raw_character_text)) %>% 
ggplot(
    aes(x = `original_air_year`, y = us_viewers_in_millions, color = raw_character_text)
  ) +
  geom_count() +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

#### Compute a IMDb votes per view - what episodes are people most passionate about?

Also add a smoothing line

```{r}
df_simpsons %>% 
  filter(grepl("Simpson|Santa's Little Helper|Obama|Trump|Millhouse|Chief Wiggum", raw_character_text)) %>% 
  mutate(votes_per_view = imdb_votes/us_viewers_in_millions) %>% 
ggplot(
    aes(x = `episode_id`, y = votes_per_view, color = raw_character_text)
    )+
  geom_point() +
  geom_smooth(color = "yellow")+
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
